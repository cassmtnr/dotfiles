#!/usr/bin/env bash

# ============================================
# Custom Application Icons Setup Script
# ============================================
# Uses fileicon to assign custom .icns files to applications
# Requires: brew install fileicon
#
# Usage: source ~/.icons or bash ~/dotfiles/.icons

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log() { echo -e "${BLUE}[ICONS]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }

# Configuration
DOTFILES_ROOT="${DOTFILES_ROOT:-$HOME/dotfiles}"
ICONS_DIR="$DOTFILES_ROOT/icons"

# Define icon mappings: icon_file:app_path
declare -a ICON_MAPPINGS=(
    "chrome.icns:/Applications/Google Chrome.app"
    "claude.icns:/Applications/Claude.app"
    "ghostty.icns:/Applications/Ghostty.app"
    "vscode.icns:/Applications/Visual Studio Code.app"
)

# Check if fileicon is installed
check_fileicon() {
    if ! command -v fileicon &> /dev/null; then
        error "fileicon is not installed. Install it with: brew install fileicon"
        return 1
    fi
    return 0
}

# Assign icon to application
assign_icon() {
    local icon_file="$1"
    local app_path="$2"
    local icon_path="$ICONS_DIR/$icon_file"

    # Check if icon exists
    if [[ ! -f "$icon_path" ]]; then
        warning "Icon not found: $icon_path"
        return 1
    fi

    # Check if application exists
    if [[ ! -d "$app_path" ]]; then
        warning "Application not found: $app_path"
        return 1
    fi

    log "Assigning icon to $(basename "$app_path")..."

    # Try without sudo first
    if fileicon set "$app_path" "$icon_path" 2>/dev/null; then
        success "Icon assigned to $(basename "$app_path")"
        return 0
    fi

    # Try with sudo if normal attempt fails (for /Applications)
    if [[ "$app_path" == /Applications/* ]]; then
        log "Retrying with elevated permissions..."
        if sudo fileicon set "$app_path" "$icon_path" 2>/dev/null; then
            success "Icon assigned to $(basename "$app_path")"
            return 0
        fi
    fi

    error "Failed to assign icon to $(basename "$app_path")"
    return 1
}

# Reset icon to default
reset_icon() {
    local app_path="$1"

    if [[ ! -d "$app_path" ]]; then
        warning "Application not found: $app_path"
        return 1
    fi

    log "Resetting icon for $(basename "$app_path")..."

    # Try without sudo first
    if fileicon rm "$app_path" 2>/dev/null; then
        success "Icon reset for $(basename "$app_path")"
        return 0
    fi

    # Try with sudo if normal attempt fails (for /Applications)
    if [[ "$app_path" == /Applications/* ]]; then
        if sudo fileicon rm "$app_path" 2>/dev/null; then
            success "Icon reset for $(basename "$app_path")"
            return 0
        fi
    fi

    warning "No custom icon to reset for $(basename "$app_path")"
    return 0
}

# List current icon status
list_icons() {
    log "Checking icon status for configured applications..."
    echo

    for mapping in "${ICON_MAPPINGS[@]}"; do
        local icon_file="${mapping%:*}"
        local app_path="${mapping#*:}"
        local app_name="$(basename "$app_path")"

        if [[ ! -d "$app_path" ]]; then
            echo -e "  ${YELLOW}○${NC} $app_name - Not installed"
            continue
        fi

        if fileicon test "$app_path" &>/dev/null; then
            echo -e "  ${GREEN}●${NC} $app_name - Custom icon set"
        else
            echo -e "  ${BLUE}○${NC} $app_name - Default icon"
        fi
    done
    echo
}

# Apply all icons
apply_all_icons() {
    log "Applying custom icons to applications..."
    echo

    local applied=0
    local failed=0

    for mapping in "${ICON_MAPPINGS[@]}"; do
        local icon_file="${mapping%:*}"
        local app_path="${mapping#*:}"

        if assign_icon "$icon_file" "$app_path"; then
            ((applied++))
        else
            ((failed++))
        fi
    done

    echo
    success "Icons applied: $applied, Failed: $failed"

    # Restart Finder and Dock to refresh icons
    log "Refreshing Finder and Dock..."
    killall Finder 2>/dev/null || true
    killall Dock 2>/dev/null || true
    success "Icon cache refreshed"
}

# Reset all icons to default
reset_all_icons() {
    log "Resetting all application icons to default..."
    echo

    for mapping in "${ICON_MAPPINGS[@]}"; do
        local app_path="${mapping#*:}"
        reset_icon "$app_path"
    done

    echo
    # Restart Finder and Dock to refresh icons
    log "Refreshing Finder and Dock..."
    killall Finder 2>/dev/null || true
    killall Dock 2>/dev/null || true
    success "All icons reset to default"
}

# Show help
show_help() {
    cat << EOF
Usage: $(basename "$0") [command]

Commands:
    apply   - Apply custom icons to all configured applications (default)
    reset   - Reset all applications to their default icons
    list    - Show current icon status for all applications
    help    - Show this help message

Configured Applications:
EOF
    for mapping in "${ICON_MAPPINGS[@]}"; do
        local icon_file="${mapping%:*}"
        local app_path="${mapping#*:}"
        echo "    • $(basename "$app_path") <- $icon_file"
    done
    echo
    echo "Icon files are located in: $ICONS_DIR"
}

# Main function
main() {
    # Check for fileicon
    check_fileicon || exit 1

    local command="${1:-apply}"

    case "$command" in
        apply)
            apply_all_icons
            ;;
        reset)
            reset_all_icons
            ;;
        list|status)
            list_icons
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            error "Unknown command: $command"
            show_help
            exit 1
            ;;
    esac
}

# Run main function if script is executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
