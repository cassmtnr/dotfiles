#!/bin/bash

# Node.js and NPM setup script
# This script sets up Node.js via NVM and installs global NPM packages

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }

log "Setting up Node.js environment..."

# Load NVM from shell environment (ensures consistency with .zshrc)
if ! command -v nvm &> /dev/null; then
    log "Loading NVM environment..."
    export NVM_DIR="$HOME/.nvm"
    if [[ -s "/opt/homebrew/opt/nvm/nvm.sh" ]]; then
        source "/opt/homebrew/opt/nvm/nvm.sh"
    elif [[ -s "$NVM_DIR/nvm.sh" ]]; then
        source "$NVM_DIR/nvm.sh"
    fi
fi

# Verify NVM is available
if ! command -v nvm &> /dev/null; then
    error "NVM not found. Please ensure NVM is installed and restart your terminal."
    error "You can install NVM with: brew install nvm"
    exit 1
fi

# Install Node.js version 22
log "Installing Node.js version 22..."
if ! nvm install 22; then
    error "Failed to install Node.js v22"
    exit 1
fi

if ! nvm use 22; then
    error "Failed to switch to Node.js v22"
    exit 1
fi

nvm alias default 22

# Show installed version
log "Node.js version: $(node --version)"
log "NPM version: $(npm --version)"

# Define global NPM packages to install
npm_packages=(
    npm
    yarn
    typescript
    eslint
    nodemon
)

# Install global NPM packages
if [ ${#npm_packages[@]} -gt 0 ]; then
    log "Installing global NPM packages..."
    if npm install -g "${npm_packages[@]}"; then
        success "Global NPM packages installed:"
        npm list -g --depth=0

        # Show Yarn version if installed
        if command -v yarn &> /dev/null; then
            log "Yarn version: $(yarn --version)"
        fi
    else
        warning "Some NPM packages failed to install"
        warning "You can retry manually with: npm install -g ${npm_packages[*]}"
    fi
else
    log "No packages to install"
fi

success "Node.js setup complete!"